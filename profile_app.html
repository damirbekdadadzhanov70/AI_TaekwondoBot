<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KukkiDo ‚Ä¢ –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* --- CSS –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ë–∞–∑–æ–≤—ã–µ –°—Ç–∏–ª–∏ --- */
    :root {
      /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Telegram –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —Ç–µ–º–∞–º */
      --bg: var(--tg-theme-bg-color, #0f1115);
      --card: var(--tg-theme-secondary-bg-color, #161a22);
      --text: var(--tg-theme-text-color, #e6e6e6);
      --muted: var(--tg-theme-hint-color, #9aa4b2);
      --acc: var(--tg-theme-button-color, #39c0ba); /* –ù–∞—à –±–∏—Ä—é–∑–æ–≤—ã–π –∞–∫—Ü–µ–Ω—Ç */
      --acc-text: var(--tg-theme-button-text-color, #fff);
      --danger: #ff5252;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", "Noto Sans", Arial;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    .wrap { max-width: 860px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-weight: 800; font-size: 24px; }
    p { color: var(--muted); margin: 0 0 16px; font-size: 14px; }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã */
    label {
      display: block;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 4px;
      margin-top: 10px; /* –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è */
      font-size: 14px;
    }
    .input-group { margin-bottom: 12px; }
    input[type="number"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--muted);
      border-radius: 12px;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: var(--acc);
    }
    textarea { min-height: 80px; resize: vertical; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 600px) {
      .row { grid-template-columns: 1fr; }
    }

    /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
      transition: opacity 0.2s, background 0.2s, transform 0.1s;
      border: none;
      font-size: 16px;

    }
    .btn.primary {
      background: var(--acc);
      color: var(--acc-text);
      margin-bottom: 8px;
    }
    .btn.secondary {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--muted);
    }
    .btn:active:not(:disabled) {
        opacity: 0.9;
        transform: scale(0.99);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* –í—ã–±–æ—Ä —Ä–æ–ª–∏ */
    .role-card { text-align: center; padding: 24px 16px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
    .role-card.disabled { opacity: 0.5; cursor: not-allowed; }
    .role-icon { font-size: 32px; margin-bottom: 8px; }
    .role-title { font-weight: 700; font-size: 18px; margin: 0; }
    .role-desc { font-size: 12px; margin-top: 4px; color: var(--muted); }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∏—Ç–æ–∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
    .inventory-selector { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
    .inventory-item {
      padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--muted);
      cursor: pointer; font-size: 14px; transition: background 0.2s, border-color 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .inventory-item.selected { background: var(--acc); color: var(--acc-text); border-color: var(--acc); font-weight: 600; }

    /* –°—Ç–∏–ª—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .engine-tag { font-size: 12px; padding: 4px 8px; border-radius: 8px; background: var(--muted); color: var(--card); }
    .result-plan {
      white-space: pre-wrap; word-break: break-word; font-family: inherit; padding: 12px; border-radius: 12px;
      background: var(--bg); border: 1px solid var(--card); line-height: 1.6; font-size: 14px;
    }
    /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
    .result-plan strong {
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      font-size: 16px;
      color: var(--acc);
      border-bottom: 1px dashed var(--muted);
      padding-bottom: 3px;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div class="wrap">


    <div id="screen-role" class="screen">
      <h1 id="welcome-message">ü•ã –ü—Ä–∏–≤–µ—Ç, –ß–µ–º–ø–∏–æ–Ω!</h1>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É KukkiDo:</p>
      <div class="row">
        <div id="role-coach" class="card role-card" onclick="selectRole('coach')">
          <div class="role-icon">üßë‚Äçüíª</div>
          <div class="role-title">–¢—Ä–µ–Ω–µ—Ä</div>
          <div class="role-desc">–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —à–∞–±–ª–æ–Ω–æ–≤</div>
        </div>
        <div id="role-athlete" class="card role-card disabled" onclick="selectRole('athlete')">
          <div class="role-icon">üèÜ</div>
          <div class="role-title">–°–ø–æ—Ä—Ç—Å–º–µ–Ω</div>
          <div class="role-desc">–î–Ω–µ–≤–Ω–∏–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫, —Ü–µ–ª–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å (—Å–∫–æ—Ä–æ)</div>
        </div>
      </div>
    </div>


    <div id="screen-coach" class="screen hidden">
      <h1>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ä–∞–∑–≤–∏—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤</h1>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ –ø–æ –º–µ—Ç–æ–¥–∏–∫–µ –¢–§–ö.</p>

      <form id="plan-form">
        <div class="card">
          <div class="row">
            <div class="input-group">
              <label for="age_band">–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
              <select id="age_band">
                <option value="junior_youth">–ú–ª–∞–¥—à–∏–µ —é–Ω–æ—à–∏ (9-11)</option>
                <option value="cadet" selected>–ö–∞–¥–µ—Ç—ã (12-14)</option>
                <option value="junior">–Æ–Ω–∏–æ—Ä—ã (15-17)</option>
                <option value="adult">–í–∑—Ä–æ—Å–ª—ã–µ (17+)</option>
              </select>
            </div>

            <div class="input-group">
              <label for="group_size">–ö–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
              <input type="number" id="group_size" min="2" max="50" value="10" placeholder="5-30">
            </div>
          </div>

          <div class="input-group">
            <label for="goal">–û—Å–Ω–æ–≤–Ω–æ–µ —Ä–∞–∑–≤–∏–≤–∞–µ–º–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (–¢–§–ö)</label>
            <select id="goal">
              <optgroup label="–ë–∞–∑–æ–≤—ã–µ –ö–∞—á–µ—Å—Ç–≤–∞">
                  <option value="strength">üí™ –°–∏–ª–∞</option>
                  <option value="speed" selected>‚ö° –°–∫–æ—Ä–æ—Å—Ç—å</option>
                  <option value="agility">ü§∏ –õ–æ–≤–∫–æ—Å—Ç—å/–ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è</option>
                  <option value="endurance">üî• –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</option>
                  <option value="flexibility">üßò –ì–∏–±–∫–æ—Å—Ç—å/–†–∞—Å—Ç—è–∂–∫–∞</option>
              </optgroup>
              <optgroup label="–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ö–∞—á–µ—Å—Ç–≤–∞">
                  <option value="strength_endurance">üèãÔ∏è –°–∏–ª–∞ + –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</option>
                  <option value="speed_agility">üèÉ –°–∫–æ—Ä–æ—Å—Ç—å + –õ–æ–≤–∫–æ—Å—Ç—å</option>
                  <option value="power_speed">üí• –í–∑—Ä—ã–≤–Ω–∞—è —Å–∏–ª–∞ + –°–∫–æ—Ä–æ—Å—Ç—å</option>
              </optgroup>
            </select>
          </div>

          <div class="row">
            <div class="input-group">
              <label for="duration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
              <input type="number" id="duration" min="30" max="120" value="60" placeholder="45-90">
            </div>

            <div class="input-group">
              <label for="location">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</label>
              <select id="location">
                <option value="dojang" selected>üèüÔ∏è –ó–∞–ª (–î–æ—è–Ω–≥)</option>
                <option value="home">üè† –î–æ–º</option>
                <option value="street">üå≥ –£–ª–∏—Ü–∞/–ü–∞—Ä–∫</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <label>–ù–∞–ª–∏—á–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (–≤—ã–±–µ—Ä–∏—Ç–µ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ)</label>
          <div id="inventory-list" class="inventory-selector">
            <div class="inventory-item" data-inv="makiwara">üéØ –õ–∞–ø—ã / –ú–∞–∫–∏–≤–∞—Ä–∞</div>
            <div class="inventory-item" data-inv="skipping_rope">‚û∞ –°–∫–∞–∫–∞–ª–∫–∞</div>
            <div class="inventory-item" data-inv="resistance_band">üîó –ñ–≥—É—Ç</div>
            <div class="inventory-item" data-inv="cones">üî∫ –ö–æ–Ω—É—Å—ã / –§–∏—à–∫–∏</div>
            <div class="inventory-item" data-inv="tennis_balls">‚öæ –ú—è—á–∏</div>
            <div class="inventory-item" data-inv="agility_ladder">ü™ú –õ–µ—Å—Ç–Ω–∏—Ü–∞</div>
            <div class="inventory-item" data-inv="hurdles">üöß –ë–∞—Ä—å–µ—Ä—ã</div>
          </div>
        </div>

        <div class="card">
          <label for="notes">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è AI</label>
          <textarea id="notes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ù—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è —Ä–∞–∑–º–∏–Ω–∫–∞', '–§–æ–∫—É—Å –Ω–∞ —Ä–∞–±–æ—Ç—É –Ω–æ–≥', '–ö–æ–Ω—Ç–∏–Ω–≥–µ–Ω—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π'"></textarea>
        </div>

        <button id="generate-btn" type="submit" class="btn primary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω (AI)</button>
        <button id="templates-btn" type="button" class="btn secondary">–ú–æ–∏ —à–∞–±–ª–æ–Ω—ã</button>
      </form>

      <div id="result-card" class="card hidden" style="margin-top: 20px;">
        <div class="result-header">
          <h2 style="font-size: 18px; margin: 0;">üìã –í–∞—à –ø–ª–∞–Ω —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h2>
          <span id="engine-span" class="engine-tag"></span>
        </div>
        <pre id="result" class="result-plan">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω.</pre>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
             <button id="save-btn" type="button" class="btn secondary" style="width: 50%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
             <button id="copy-btn" type="button" class="btn secondary" style="width: 50%;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>
        </div>
      </div>

      <button id="back-to-role-btn" type="button" class="btn secondary" style="margin-top: 20px;">
        ‚Üê –ù–∞–∑–∞–¥
      </button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä backend, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –±–æ—Ç–æ–º, –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –∞–¥—Ä–µ—Å
    const BACKEND_URL_PARAM = new URLSearchParams(window.location.search).get('backend');
    const BACKEND_URL = BACKEND_URL_PARAM || "http://127.0.0.1:8000";

    const $ = (id) => document.getElementById(id);

    // --- –§–£–ù–ö–¶–ò–Ø API-–ó–ê–ü–†–û–°–ê –° –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ï–ô ---
    const postJSON = async (url, data) => {
      const init_data = tg.initData;
      if (!init_data) {
          tg.showAlert("–û—à–∏–±–∫–∞: Telegram initData –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Mini App.");
          throw new Error("Missing initData");
      }

      const response = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –¥—Ä—É–≥–∏–º–∏ GET/POST)
            'X-TMA-Init-Data': init_data,
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const errorText = await response.text();
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π TWA-–º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        tg.showAlert(`–û—à–∏–±–∫–∞ API: HTTP ${response.status}\n${errorText || 'Unknown error'}`);
        throw new Error(`HTTP ${response.status}: ${errorText || 'Unknown error'}`);
      }
      return response.json();
    };

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ---
    tg.ready();
    tg.expand();
    tg.MainButton.hide();

    const screens = { role: $('screen-role'), coach: $('screen-coach') };

    if (tg.initDataUnsafe?.user?.first_name) {
        $('welcome-message').textContent = `ü•ã –ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe.user.first_name}!`;
    }

    function switchScreen(activeScreen) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        activeScreen.classList.remove('hidden');
        if (activeScreen === screens.role) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
            $('result-card').classList.add('hidden');
        }
    }

    function selectRole(role) {
        if (role === 'coach') {
            tg.HapticFeedback?.notificationOccurred('success');
            switchScreen(screens.coach);
        } else if (role === 'athlete') {
             tg.HapticFeedback?.notificationOccurred('error');
             tg.showAlert("–†–∞–∑–¥–µ–ª '–°–ø–æ—Ä—Ç—Å–º–µ–Ω' –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.");
        }
    }

    $('back-to-role-btn').addEventListener('click', () => {
        switchScreen(screens.role);
    });

    // --- –õ–û–ì–ò–ö–ê –ò–ù–í–ï–ù–¢–ê–†–Ø (–ü–õ–ò–¢–ö–ò) ---
    const inventoryItems = document.querySelectorAll('.inventory-item');
    inventoryItems.forEach(item => {
        item.addEventListener('click', () => {
            item.classList.toggle('selected');
            tg.HapticFeedback?.impactOccurred('light');
        });
    });

    function getInventoryList() {
        return Array.from(document.querySelectorAll('.inventory-item.selected'))
                    .map(item => item.getAttribute('data-inv'));
    }

    // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–õ–ê–ù–ê ---
    const genBtn = $('generate-btn');
    const saveBtn = $('save-btn');
    const copyBtn = $('copy-btn');
    const resultCard = $('result-card');
    const resultPre = $('result');
    const engineSpan = $('engine-span');
    const form = $('plan-form');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      genBtn.disabled = true;
      saveBtn.disabled = true;
      copyBtn.disabled = true;
      resultCard.classList.add('hidden');
      resultPre.textContent = "‚öôÔ∏è –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–ª–∞–Ω...";
      tg.HapticFeedback?.impactOccurred('medium');

      try {
        const inv = getInventoryList();

        // üåü –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò 422: –§–æ—Ä–º–∏—Ä—É–µ–º –ø–ª–æ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.
        const requestData = {
          // 1. init_data –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–µ–ª–µ –¥–ª—è Pydantic-–º–æ–¥–µ–ª–∏ –±—ç–∫–µ–Ω–¥–∞.
          init_data: tg.initData,

          age_band: $('age_band').value,
          // 2. Number() –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —ç—Ç–æ —á–∏—Å–ª–æ, –∞ || fallback –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É null/NaN.
          group_size: Number($('group_size').value || 10),
          goal: $('goal').value,
          duration: Number($('duration').value || 60),
          location: $('location').value,
          // 3. inv.length > 0 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –±—É–ª–µ–≤–æ –∑–Ω–∞—á–µ–Ω–∏–µ (true/false).
          inventory: inv.length > 0,
          inventory_list: inv
        };
        // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: 'notes' –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ –æ–∂–∏–¥–∞–µ—Ç—Å—è Pydantic-–º–æ–¥–µ–ª—å—é CoachPlanRequest.
        // –ï—Å–ª–∏ –æ–Ω –Ω—É–∂–µ–Ω AI, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
        const data = await postJSON(BACKEND_URL + "/api/coach_plan", requestData);

        // üåü –õ–û–ì–ò–ö–ê –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–õ–Ø –ö–†–ê–°–û–¢–´ üåü
        let formattedPlan = data.plan
            // –ó–∞–º–µ–Ω—è–µ–º \n –Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã, –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—ç–∫–µ–Ω–¥–µ
            .replace(/\\n/g, '\n')
            // –ò—â–µ–º –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (–æ—Ç GPT) –∏–ª–∏ —è–≤–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–°—Ç–∞–Ω—Ü–∏—è, –ó–∞–º–µ—Ç–∫–∏ —Ç—Ä–µ–Ω–µ—Ä—É)
            // –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∏—Ö –≤ <strong> –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ CSS.
            .replace(/(\*\*([^*]+)\*\*)|(–°—Ç–∞–Ω—Ü–∏—è\s+[A-Z–ê-–Ø]\s*‚Äî\s*[^:]+)|(–ó–∞–º–µ—Ç–∫–∏ —Ç—Ä–µ–Ω–µ—Ä—É:)|(##\s*[^#]+)/g, (match, gptBold, gptText) => {
                // –ï—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª gptBold (—Ç–µ–∫—Å—Ç –≤ **), –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                if (gptBold) return `<strong>${gptText.trim()}</strong>`;
                // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π match (–°—Ç–∞–Ω—Ü–∏—è, –ó–∞–º–µ—Ç–∫–∏ –∏–ª–∏ –ó–∞–≥–æ–ª–æ–≤–æ–∫ MD)
                return `<strong>${match.replace(/##\s*/, '').trim()}</strong>`;
            });

        resultPre.innerHTML = formattedPlan;
        engineSpan.textContent = data.engine === "gpt" ? "üß† AI (GPT)" : "‚öôÔ∏è Rule-based";
        resultCard.classList.remove("hidden");
        saveBtn.disabled = false;
        copyBtn.disabled = false;
        tg.HapticFeedback?.notificationOccurred("success");
      } catch (e) {
        // –û—à–∏–±–∫–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ postJSON —á–µ—Ä–µ–∑ tg.showAlert
        resultPre.textContent = `‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞.`;
        engineSpan.textContent = "";
        resultCard.classList.remove("hidden");
        tg.HapticFeedback?.notificationOccurred("error");
      } finally {
        genBtn.disabled = false;
      }
    });

    // --- –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –¢–ï–ö–°–¢–ê ---
    copyBtn?.addEventListener("click", () => {
        const plan = resultPre.textContent;
        if (!plan || plan.startsWith("‚ùå")) {
            tg.showAlert("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω.");
            return;
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.execCommand('copy') –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ iframe
        const textarea = document.createElement('textarea');
        textarea.value = plan;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            tg.HapticFeedback?.notificationOccurred("success");
            tg.showAlert("‚úÖ –ü–ª–∞–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
        } catch (err) {
            tg.showAlert("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ.");
        }
        document.body.removeChild(textarea);
    });

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï –®–ê–ë–õ–û–ù–ê (–£–ª—É—á—à–µ–Ω–æ —Å tg.showPopup) ---
    saveBtn?.addEventListener("click", () => {
      const plan = $('result').textContent;
      if (!plan || plan.startsWith("‚ùå")) {
          tg.showAlert("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞–Ω.");
          return;
      }

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º prompt() –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è
      const name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞:");
      if (!name) return;

      saveBtn.disabled = true;

      try {
        const inv = getInventoryList();
        // üåü –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
        const params = {
          age_band: $('age_band').value,
          group_size: Number($('group_size').value || 10),
          goal: $('goal').value,
          duration: Number($('duration').value || 60),
          location: $('location').value,
          inventory: inv.length > 0,
          inventory_list: inv
        };

        // –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π POST-–∑–∞–ø—Ä–æ—Å
        await postJSON(BACKEND_URL + "/api/templates/save", {
            init_data: tg.initData, // –î–æ–±–∞–≤–ª—è–µ–º init_data –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            name,
            plan,
            params
        });
        tg.showAlert(`‚úÖ –®–∞–±–ª–æ–Ω '${name}' —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`);
      } catch (e) {
        // –û—à–∏–±–∫–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –≤ postJSON
      } finally {
        saveBtn.disabled = false;
      }
    });

    // --- –ó–ê–ì–†–£–ó–ö–ê –ò–ó–ù–ê–ß–ê–õ–¨–ù–û–ì–û –≠–ö–†–ê–ù–ê ---
    switchScreen(screens.role);
  </script>

</body>
</html>