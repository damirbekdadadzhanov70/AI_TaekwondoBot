<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KukkiDo ‚Ä¢ –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0f1115; --card:#161a22; --text:#e6e6e6; --muted:#9aa4b2; --acc:#39c0ba; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue","Noto Sans",Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 860px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0 0 12px; font-weight: 700; font-size: 20px; }
    p { color: var(--muted); margin: 0 0 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media(min-width:800px){ .grid{ grid-template-columns: repeat(2,1fr);} }
    .card { background: var(--card); border-radius: 16px; padding: 14px; border: 1px solid #222735; }
    .btn { appearance: none; border: 0; background: var(--acc); color: #0a0d10; font-weight: 700; padding: 12px 14px; border-radius: 12px; cursor: pointer; width: 100%; }
    .btn.outline { background: transparent; color: var(--text); border: 1px solid #2a3242; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 13px; margin-bottom:6px; color:#c5cedb; }
    input[type="number"], select, input[type="text"], textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3242; background: #0d1118; color: var(--text);
    }
    select[multiple] { min-height: 160px; }
    textarea { min-height: 90px; }
    .hidden { display:none; }
    .muted { font-size: 12px; color:#97a3b4; }
    pre { white-space: pre-wrap; background:#0b0e13; border:1px solid #202636; padding:12px; border-radius: 12px; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>KukkiDo</h1>
    <p id="subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å –∏ –Ω–∞—á–Ω–∏—Ç–µ ‚Äî –ø–ª–∞–Ω—ã –∏ –¥–Ω–µ–≤–Ω–∏–∫–∏ –¥–µ–ª–∞–µ–º –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –≤–Ω—É—Ç—Ä–∏ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>

    <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ -->
    <div id="screen-role" class="grid">
      <div class="card">
        <h3>–¢—Ä–µ–Ω–µ—Ä</h3>
        <p class="muted">–ü–ª–∞–Ω—ã –¥–ª—è –≥—Ä—É–ø–ø, —à–∞–±–ª–æ–Ω—ã, –∑–∞–º–µ—Ç–∫–∏ –∏ —Ä–æ—Ç–∞—Ü–∏—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π.</p>
        <button class="btn" id="pick-coach">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ —Ç—Ä–µ–Ω–µ—Ä</button>
      </div>
      <div class="card">
        <h3>–°–ø–æ—Ä—Ç—Å–º–µ–Ω</h3>
        <p class="muted">–î–Ω–µ–≤–Ω–∏–∫ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ‚Äî —Å–∫–æ—Ä–æ.</p>
        <button class="btn outline" id="pick-athlete" disabled>–°–∫–æ—Ä–æ</button>
      </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —Ç—Ä–µ–Ω–µ—Ä–∞ -->
    <div id="screen-coach" class="hidden">
      <div class="card">
        <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–ø–ø—ã</h3>
        <div class="row">
          <div>
            <label>–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
            <select id="age_band">
              <option value="U9">U9</option>
              <option value="U11">U11</option>
              <option value="U13" selected>U13</option>
              <option value="U17">U17</option>
              <option value="Adults">–í–∑—Ä–æ—Å–ª—ã–µ</option>
            </select>
          </div>
          <div>
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–µ–π</label>
            <input type="number" id="group_size" value="10" min="2" max="30"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>–¶–µ–ª—å</label>
            <select id="goal">
              <option>–°–∫–æ—Ä–æ—Å—Ç—å</option>
              <option>–°–∏–ª–∞</option>
              <option>–õ–æ–≤–∫–æ—Å—Ç—å</option>
              <option>–ì–∏–±–∫–æ—Å—Ç—å</option>
              <option>–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å</option>
              <option selected>–û–±—â–∞—è</option>
            </select>
          </div>
          <div>
            <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
            <input type="number" id="duration" value="45" min="20" max="120"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>–õ–æ–∫–∞—Ü–∏—è</label>
            <select id="location">
              <option selected>–ó–∞–ª</option>
              <option>–î–æ–º</option>
              <option>–£–ª–∏—Ü–∞</option>
            </select>
          </div>
          <div>
            <label>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ)</label>
            <select id="inventory" multiple>
              <option value="pads">–õ–∞–ø—ã</option>
              <option value="rope">–°–∫–∞–∫–∞–ª–∫–∞</option>
              <option value="bands">–ñ–≥—É—Ç</option>
              <option value="cones">–ö–æ–Ω—É—Å—ã</option>
              <option value="makiwara">–ú–∞–∫–µ–≤–∞—Ä–∞</option>
              <option value="ball">–ú—è—á–∏</option>
              <option value="ladder">–õ–µ—Å—Ç–Ω–∏—Ü–∞</option>
              <option value="hurdles">–ë–∞—Ä—å–µ—Ä—ã</option>
            </select>
            <div class="muted" style="margin-top:6px;">–û—Ç–º–µ—Ç—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å ‚Äî –≤–ª–∏—èe—Ç –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é –ø–ª–∞–Ω–∞.</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>–ó–∞–º–µ—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea id="notes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —É –¥–≤–æ–∏—Ö —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–µ–Ω–æ ‚Äî –∏–∑–±–µ–≥–∞—Ç—å –ø—Ä—ã–∂–∫–æ–≤."></textarea>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="gen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω</button>
          <button class="btn outline" id="save" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω</button>
        </div>
      </div>

      <div class="card hidden" id="result-card">
        <div class="right muted" id="engine"></div>
        <pre id="result"></pre>
      </div>
    </div>
  </div>

  <script>
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ backend –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ URL (–±–æ—Ç –µ–≥–æ –¥–æ–±–∞–≤–ª—è–µ—Ç), –∏–Ω–∞—á–µ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç:
    const BACKEND_URL =
      new URLSearchParams(location.search).get('backend') ||
      (window.BACKEND_URL || "http://localhost:8001");

    const tg = window.Telegram?.WebApp;
    tg?.expand();

    function $(id){ return document.getElementById(id); }

    const subtitle = $("subtitle");
    const scrRole = $("screen-role"), scrCoach = $("screen-coach");
    const pickCoach = $("pick-coach");
    const genBtn = $("gen"), saveBtn = $("save");
    const resultCard = $("result-card"), resultPre = $("result"), engineSpan = $("engine");

    pickCoach?.addEventListener("click", () => {
      scrRole.classList.add("hidden");
      scrCoach.classList.remove("hidden");
      subtitle.textContent = "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: –∑–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä—É–ø–ø—ã –∏ –ø–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω.";
      tg?.HapticFeedback?.impactOccurred("soft");
    });

    async function postJSON(url, data){
      const resp = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      });
      if (!resp.ok) throw new Error(await resp.text());
      return await resp.json();
    }

    function getInventoryList(){
      const sel = $("inventory");
      return Array.from(sel?.selectedOptions || []).map(o => o.value);
    }

    genBtn?.addEventListener("click", async () => {
      try {
        genBtn.disabled = true; saveBtn.disabled = true;

        const inv = getInventoryList();
        const params = {
          age_band: $("age_band").value,
          group_size: Number($("group_size").value || 10),
          goal: $("goal").value,
          duration: Number($("duration").value || 45),
          location: $("location").value,
          inventory: inv.length > 0,
          inventory_list: inv
        };
        const notes = $("notes").value || "";
        const uid = tg?.initDataUnsafe?.user?.id || 0;

        const data = await postJSON(BACKEND_URL + "/api/coach_plan", { user_id: uid, params, notes });
        resultPre.textContent = data.plan;
        engineSpan.textContent = data.engine === "gpt" ? "üß† GPT" : "‚öôÔ∏è Rule-based";
        resultCard.classList.remove("hidden");
        saveBtn.disabled = false;
        tg?.HapticFeedback?.notificationOccurred("success");
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: " + e);
      } finally {
        genBtn.disabled = false;
      }
    });

    saveBtn?.addEventListener("click", async () => {
      try {
        const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞:");
        if (!name) return;

        const inv = getInventoryList();
        const params = {
          age_band: $("age_band").value,
          group_size: Number($("group_size").value || 10),
          goal: $("goal").value,
          duration: Number($("duration").value || 45),
          location: $("location").value,
          inventory: inv.length > 0,
          inventory_list: inv
        };
        const uid = tg?.initDataUnsafe?.user?.id || 0;
        const plan = $("result").textContent || "";

        await postJSON(BACKEND_URL + "/api/templates/save", { user_id: uid, name, plan, params });
        alert("–®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ");
      } catch (e) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω: " + e);
      }
    });
  </script>
</body>
</html>
